import{__toESM as e,basis_default as t,common$1 as n,configureSvgSize as r,getConfig as i,log$1 as a,require_dayjs_min as o,require_dist as s,select_default as c,utils as l}from"./mermaid-b5860b54.CzyV0eq4.js";import"./preload-helper.C0X9M0sG.js";import"./path.CnsJDNhh.js";import"./array.DpZ2OJ07.js";import{line_default as u}from"./line.DTlckFuN.js";import{Graph as d}from"./graphlib.B9UfIqo0.js";import{layout as f}from"./dagre.v2GxACLv.js";import{db as p,parser$1 as m,styles as h}from"./styles-6aaf32cf.zv4wI12s.js";var g=e(o()),_=e(s());const v={},y=(e,t)=>{v[e]=t},b=e=>v[e],x=()=>Object.keys(v),S=()=>x().length,C={get:b,set:y,keys:x,size:S},w=e=>e.append(`circle`).attr(`class`,`start-state`).attr(`r`,i().state.sizeUnit).attr(`cx`,i().state.padding+i().state.sizeUnit).attr(`cy`,i().state.padding+i().state.sizeUnit),T=e=>e.append(`line`).style(`stroke`,`grey`).style(`stroke-dasharray`,`3`).attr(`x1`,i().state.textHeight).attr(`class`,`divider`).attr(`x2`,i().state.textHeight*2).attr(`y1`,0).attr(`y2`,0),E=(e,t)=>{let n=e.append(`text`).attr(`x`,2*i().state.padding).attr(`y`,i().state.textHeight+2*i().state.padding).attr(`font-size`,i().state.fontSize).attr(`class`,`state-title`).text(t.id),r=n.node().getBBox();return e.insert(`rect`,`:first-child`).attr(`x`,i().state.padding).attr(`y`,i().state.padding).attr(`width`,r.width+2*i().state.padding).attr(`height`,r.height+2*i().state.padding).attr(`rx`,i().state.radius),n},D=(e,t)=>{let n=function(e,t,n){let r=e.append(`tspan`).attr(`x`,2*i().state.padding).text(t);n||r.attr(`dy`,i().state.textHeight)},r=e.append(`text`).attr(`x`,2*i().state.padding).attr(`y`,i().state.textHeight+1.3*i().state.padding).attr(`font-size`,i().state.fontSize).attr(`class`,`state-title`).text(t.descriptions[0]),a=r.node().getBBox(),o=a.height,s=e.append(`text`).attr(`x`,i().state.padding).attr(`y`,o+i().state.padding*.4+i().state.dividerMargin+i().state.textHeight).attr(`class`,`state-description`),c=!0,l=!0;t.descriptions.forEach(function(e){c||(n(s,e,l),l=!1),c=!1});let u=e.append(`line`).attr(`x1`,i().state.padding).attr(`y1`,i().state.padding+o+i().state.dividerMargin/2).attr(`y2`,i().state.padding+o+i().state.dividerMargin/2).attr(`class`,`descr-divider`),d=s.node().getBBox(),f=Math.max(d.width,a.width);return u.attr(`x2`,f+3*i().state.padding),e.insert(`rect`,`:first-child`).attr(`x`,i().state.padding).attr(`y`,i().state.padding).attr(`width`,f+2*i().state.padding).attr(`height`,d.height+o+2*i().state.padding).attr(`rx`,i().state.radius),e},O=(e,t,n)=>{let r=i().state.padding,a=2*i().state.padding,o=e.node().getBBox(),s=o.width,c=o.x,l=e.append(`text`).attr(`x`,0).attr(`y`,i().state.titleShift).attr(`font-size`,i().state.fontSize).attr(`class`,`state-title`).text(t.id),u=l.node().getBBox(),d=u.width+a,f=Math.max(d,s);f===s&&(f+=a);let p,m=e.node().getBBox();t.doc,p=c-r,d>s&&(p=(s-f)/2+r),Math.abs(c-m.x)<r&&d>s&&(p=c-(d-s)/2);let h=1-i().state.textHeight;return e.insert(`rect`,`:first-child`).attr(`x`,p).attr(`y`,h).attr(`class`,n?`alt-composit`:`composit`).attr(`width`,f).attr(`height`,m.height+i().state.textHeight+i().state.titleShift+1).attr(`rx`,`0`),l.attr(`x`,p+r),d<=s&&l.attr(`x`,c+(f-a)/2-d/2+r),e.insert(`rect`,`:first-child`).attr(`x`,p).attr(`y`,i().state.titleShift-i().state.textHeight-i().state.padding).attr(`width`,f).attr(`height`,i().state.textHeight*3).attr(`rx`,i().state.radius),e.insert(`rect`,`:first-child`).attr(`x`,p).attr(`y`,i().state.titleShift-i().state.textHeight-i().state.padding).attr(`width`,f).attr(`height`,m.height+3+2*i().state.textHeight).attr(`rx`,i().state.radius),e},k=e=>(e.append(`circle`).attr(`class`,`end-state-outer`).attr(`r`,i().state.sizeUnit+i().state.miniPadding).attr(`cx`,i().state.padding+i().state.sizeUnit+i().state.miniPadding).attr(`cy`,i().state.padding+i().state.sizeUnit+i().state.miniPadding),e.append(`circle`).attr(`class`,`end-state-inner`).attr(`r`,i().state.sizeUnit).attr(`cx`,i().state.padding+i().state.sizeUnit+2).attr(`cy`,i().state.padding+i().state.sizeUnit+2)),A=(e,t)=>{let n=i().state.forkWidth,r=i().state.forkHeight;if(t.parentId){let e=n;n=r,r=e}return e.append(`rect`).style(`stroke`,`black`).style(`fill`,`black`).attr(`width`,n).attr(`height`,r).attr(`x`,i().state.padding).attr(`y`,i().state.padding)},j=(e,t,r,a)=>{let o=0,s=a.append(`text`);s.style(`text-anchor`,`start`),s.attr(`class`,`noteText`);let c=e.replace(/\r\n/g,`<br/>`);c=c.replace(/\n/g,`<br/>`);let l=c.split(n.lineBreakRegex),u=1.25*i().state.noteMargin;for(let e of l){let n=e.trim();if(n.length>0){let e=s.append(`tspan`);if(e.text(n),u===0){let t=e.node().getBBox();u+=t.height}o+=u,e.attr(`x`,t+i().state.noteMargin),e.attr(`y`,r+o+1.25*i().state.noteMargin)}}return{textWidth:s.node().getBBox().width,textHeight:o}},M=(e,t)=>{t.attr(`class`,`state-note`);let n=t.append(`rect`).attr(`x`,0).attr(`y`,i().state.padding),r=t.append(`g`),{textWidth:a,textHeight:o}=j(e,0,0,r);return n.attr(`height`,o+2*i().state.noteMargin),n.attr(`width`,a+i().state.noteMargin*2),n},N=function(e,t){let n=t.id,r={id:n,label:t.id,width:0,height:0},a=e.append(`g`).attr(`id`,n).attr(`class`,`stateGroup`);t.type===`start`&&w(a),t.type===`end`&&k(a),(t.type===`fork`||t.type===`join`)&&A(a,t),t.type===`note`&&M(t.note.text,a),t.type===`divider`&&T(a),t.type===`default`&&t.descriptions.length===0&&E(a,t),t.type===`default`&&t.descriptions.length>0&&D(a,t);let o=a.node().getBBox();return r.width=o.width+2*i().state.padding,r.height=o.height+2*i().state.padding,C.set(n,r),r};let P=0;const F=function(e,r,o){let s=function(e){switch(e){case p.relationType.AGGREGATION:return`aggregation`;case p.relationType.EXTENSION:return`extension`;case p.relationType.COMPOSITION:return`composition`;case p.relationType.DEPENDENCY:return`dependency`}};r.points=r.points.filter(e=>!Number.isNaN(e.y));let c=r.points,d=u().x(function(e){return e.x}).y(function(e){return e.y}).curve(t),f=e.append(`path`).attr(`d`,d(c)).attr(`id`,`edge`+P).attr(`class`,`transition`),m=``;if(i().state.arrowMarkerAbsolute&&(m=window.location.protocol+`//`+window.location.host+window.location.pathname+window.location.search,m=m.replace(/\(/g,`\\(`),m=m.replace(/\)/g,`\\)`)),f.attr(`marker-end`,`url(`+m+`#`+s(p.relationType.DEPENDENCY)+`End)`),o.title!==void 0){let t=e.append(`g`).attr(`class`,`stateLabel`),{x:s,y:c}=l.calcLabelPosition(r.points),u=n.getRows(o.title),d=0,f=[],p=0,m=0;for(let e=0;e<=u.length;e++){let n=t.append(`text`).attr(`text-anchor`,`middle`).text(u[e]).attr(`x`,s).attr(`y`,c+d),r=n.node().getBBox();if(p=Math.max(p,r.width),m=Math.min(m,r.x),a.info(r.x,s,c+d),d===0){let e=n.node().getBBox();d=e.height,a.info(`Title height`,d,c)}f.push(n)}let h=d*u.length;if(u.length>1){let e=(u.length-1)*d*.5;f.forEach((t,n)=>t.attr(`y`,c+n*d-e)),h=d*u.length}let g=t.node().getBBox();t.insert(`rect`,`:first-child`).attr(`class`,`box`).attr(`x`,s-p/2-i().state.padding/2).attr(`y`,c-h/2-i().state.padding/2-3.5).attr(`width`,p+i().state.padding).attr(`height`,h+i().state.padding),a.info(g)}P++};let I;const L={},R=function(){},z=function(e){e.append(`defs`).append(`marker`).attr(`id`,`dependencyEnd`).attr(`refX`,19).attr(`refY`,7).attr(`markerWidth`,20).attr(`markerHeight`,28).attr(`orient`,`auto`).append(`path`).attr(`d`,`M 19,7 L9,13 L14,7 L9,1 Z`)},B=function(e,t,n,o){I=i().state;let s=i().securityLevel,l;s===`sandbox`&&(l=c(`#i`+t));let u=c(s===`sandbox`?l.nodes()[0].contentDocument.body:`body`),d=s===`sandbox`?l.nodes()[0].contentDocument:document;a.debug(`Rendering diagram `+e);let f=u.select(`[id='${t}']`);z(f);let p=o.db.getRootDoc();H(p,f,void 0,!1,u,d,o);let m=I.padding,h=f.node().getBBox(),g=h.width+m*2,_=h.height+m*2,v=g*1.75;r(f,_,v,I.useMaxWidth),f.attr(`viewBox`,`${h.x-I.padding}  ${h.y-I.padding} `+g+` `+_)},V=e=>e?e.length*I.fontSizeFactor:1,H=(e,t,r,i,o,s,c)=>{let l=new d({compound:!0,multigraph:!0}),u,p=!0;for(u=0;u<e.length;u++)if(e[u].stmt===`relation`){p=!1;break}r?l.setGraph({rankdir:`LR`,multigraph:!0,compound:!0,ranker:`tight-tree`,ranksep:p?1:I.edgeLengthFactor,nodeSep:p?1:50,isMultiGraph:!0}):l.setGraph({rankdir:`TB`,multigraph:!0,compound:!0,ranksep:p?1:I.edgeLengthFactor,nodeSep:p?1:50,ranker:`tight-tree`,isMultiGraph:!0}),l.setDefaultEdgeLabel(function(){return{}}),c.db.extract(e);let m=c.db.getStates(),h=c.db.getRelations(),g=Object.keys(m);for(let e of g){let n=m[e];r&&(n.parentId=r);let a;if(n.doc){let e=t.append(`g`).attr(`id`,n.id).attr(`class`,`stateGroup`);a=H(n.doc,e,n.id,!i,o,s,c);{e=O(e,n,i);let t=e.node().getBBox();a.width=t.width,a.height=t.height+I.padding/2,L[n.id]={y:I.compositTitleSize}}}else a=N(t,n);if(n.note){let e={descriptions:[],id:n.id+`-note`,note:n.note,type:`note`},r=N(t,e);n.note.position===`left of`?(l.setNode(a.id+`-note`,r),l.setNode(a.id,a)):(l.setNode(a.id,a),l.setNode(a.id+`-note`,r)),l.setParent(a.id,a.id+`-group`),l.setParent(a.id+`-note`,a.id+`-group`)}else l.setNode(a.id,a)}a.debug(`Count=`,l.nodeCount(),l);let _=0;h.forEach(function(e){_++,a.debug(`Setting edge`,e),l.setEdge(e.id1,e.id2,{relation:e,width:V(e.title),height:I.labelHeight*n.getRows(e.title).length,labelpos:`c`},`id`+_)}),f(l),a.debug(`Graph after layout`,l.nodes());let v=t.node();l.nodes().forEach(function(e){if(e!==void 0&&l.node(e)!==void 0){a.warn(`Node `+e+`: `+JSON.stringify(l.node(e))),o.select(`#`+v.id+` #`+e).attr(`transform`,`translate(`+(l.node(e).x-l.node(e).width/2)+`,`+(l.node(e).y+(L[e]?L[e].y:0)-l.node(e).height/2)+` )`),o.select(`#`+v.id+` #`+e).attr(`data-x-shift`,l.node(e).x-l.node(e).width/2);let t=s.querySelectorAll(`#`+v.id+` #`+e+` .divider`);t.forEach(e=>{let t=e.parentElement,n=0,r=0;t&&(t.parentElement&&(n=t.parentElement.getBBox().width),r=parseInt(t.getAttribute(`data-x-shift`),10),Number.isNaN(r)&&(r=0)),e.setAttribute(`x1`,0-r+8),e.setAttribute(`x2`,n-r-8)})}else a.debug(`No Node `+e+`: `+JSON.stringify(l.node(e)))});let y=v.getBBox();l.edges().forEach(function(e){e!==void 0&&l.edge(e)!==void 0&&(a.debug(`Edge `+e.v+` -> `+e.w+`: `+JSON.stringify(l.edge(e))),F(t,l.edge(e),l.edge(e).relation))}),y=v.getBBox();let b={id:r||`root`,label:r||`root`,width:0,height:0};return b.width=y.width+2*I.padding,b.height=y.height+2*I.padding,a.debug(`Doc rendered`,b,l),b},U={setConf:R,draw:B},W={parser:m,db:p,renderer:U,styles:h,init:e=>{e.state||={},e.state.arrowMarkerAbsolute=e.arrowMarkerAbsolute,p.clear()}};export{W as diagram};